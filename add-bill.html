<!DOCTYPE html>
<html lang="en" class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add Bill - Wealthwise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
</head>
<body class="min-h-screen p-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Manage Monthly Bills</h1>
    <button id="toggle-theme" class="text-sm border px-3 py-1 rounded">Toggle Theme</button>
  </div>

  <form id="bill-form" class="space-y-4 max-w-md mb-10">
    <input type="hidden" id="bill-id">
    <div>
      <label class="block">Bill Name</label>
      <input type="text" id="name" class="w-full p-2 border rounded dark:bg-gray-800" required>
    </div>
    <div>
  <label class="block">Amount ($)</label>
  <input type="number" step="0.01" id="amount" class="w-full p-2 border rounded dark:bg-gray-800" required>
</div>
    <div>
      <label class="block">Due Day (1-31)</label>
      <input type="number" id="due_day" min="1" max="31" class="w-full p-2 border rounded dark:bg-gray-800" required>
    </div>
    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" id="submit-btn">Add Bill</button>
    <button type="button" id="cancel-edit" class="ml-2 text-sm text-red-500 hidden">Cancel Edit</button>
  </form>

  <div class="max-w-xl">
    <h2 class="text-xl font-semibold mb-4">Your Bills</h2>
    <ul id="bills-list" class="space-y-3"></ul>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = 'https://anwwjqupywbnwanuckdf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFud3dqcXVweXdibndhbnVja2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MzgxOTksImV4cCI6MjA2NTAxNDE5OX0.ExlSkJTP3mJ9u-7SVws0FYcNvlL9a4MJNsm8ZaK1X48';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    document.getElementById('toggle-theme').onclick = () => {
      document.documentElement.classList.toggle('dark');
    };

    const { data: sessionData } = await supabase.auth.getUser();
    if (!sessionData.user) {
      window.location.href = '/login.html';
    }
    const userId = sessionData.user.id;

    async function loadBills() {
      const { data, error } = await supabase
        .from('bills')
        .select('*')
        .eq('user_id', userId)
        .order('due_day');

      const list = document.getElementById('bills-list');
      list.innerHTML = '';

      if (error) {
        list.innerHTML = `<li class="text-red-500">Error loading bills: ${error.message}</li>`;
        return;
      }

      if (data.length === 0) {
        list.innerHTML = `<li class="text-gray-500">No bills added yet.</li>`;
        return;
      }

      data.forEach(bill => {
        const li = document.createElement('li');
        li.className = 'p-4 bg-gray-100 dark:bg-gray-800 rounded shadow-sm flex justify-between items-center';
        li.innerHTML = `
          <div>
            <div class="font-semibold">${bill.name}</div>
            <div class="text-sm">Amount: $${bill.amount.toFixed(2)} | Due Day: ${bill.due_day}</div>
          </div>
          <div class="space-x-2">
            <button class="edit-btn text-blue-500 underline" data-id="${bill.id}" data-name="${bill.name}" data-amount="${bill.amount}" data-due="${bill.due_day}">Edit</button>
            <button class="delete-btn text-red-500 underline" data-id="${bill.id}">Delete</button>
          </div>
        `;
        list.appendChild(li);
      });

      // Attach handlers
      document.querySelectorAll('.edit-btn').forEach(btn =>
        btn.onclick = () => startEdit(btn.dataset)
      );

      document.querySelectorAll('.delete-btn').forEach(btn =>
        btn.onclick = async () => {
          if (confirm('Are you sure you want to delete this bill?')) {
            const { error } = await supabase.from('bills').delete().eq('id', btn.dataset.id);
            if (error) {
              alert('Error deleting bill: ' + error.message);
            } else {
              await loadBills();
            }
          }
        }
      );
    }

    function startEdit(data) {
      document.getElementById('bill-id').value = data.id;
      document.getElementById('name').value = data.name;
      document.getElementById('amount').value = data.amount;
      document.getElementById('due_day').value = data.due;
      document.getElementById('submit-btn').textContent = 'Update Bill';
      document.getElementById('cancel-edit').classList.remove('hidden');
    }

    function resetForm() {
      document.getElementById('bill-id').value = '';
      document.getElementById('bill-form').reset();
      document.getElementById('submit-btn').textContent = 'Add Bill';
      document.getElementById('cancel-edit').classList.add('hidden');
    }

    document.getElementById('cancel-edit').onclick = resetForm;

    document.getElementById('bill-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('bill-id').value;
      const name = document.getElementById('name').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const due_day = parseInt(document.getElementById('due_day').value);

      if (id) {
        // Update
        const { error } = await supabase
          .from('bills')
          .update({ name, amount, due_day })
          .eq('id', id)
          .eq('user_id', userId);

        if (error) {
          alert('Error updating bill: ' + error.message);
          return;
        }
      } else {
        // Insert
        const { error } = await supabase.from('bills').insert({
          user_id: userId,
          name,
          amount,
          due_day
        });

        if (error) {
          alert('Error adding bill: ' + error.message);
          return;
        }
      }

      resetForm();
      await loadBills();
    });

    await loadBills();
  </script>
</body>
</html>