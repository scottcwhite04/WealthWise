<!DOCTYPE html>
<html lang="en" class="bg-gray-100 dark:bg-gray-900">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Bill – Wealthwise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="w-full flex justify-between items-center px-4 py-4 bg-white dark:bg-gray-800 shadow">
    <h1 class="text-xl font-bold dark:text-white">Wealthwise</h1>
    <button onclick="toggleTheme()" class="text-xl">🌓</button>
  </header>

  <!-- Page Content -->
  <main class="flex-1 px-4 py-6 w-full max-w-3xl mx-auto space-y-6 pb-40">
    <!-- Bill Form -->
    <form id="bill-form" class="bg-white dark:bg-gray-800 p-6 rounded shadow space-y-4">
      <input type="hidden" id="editing-id" />
      <h2 class="text-lg font-semibold dark:text-white">Add or Edit Bill</h2>
      <input type="text" id="name" placeholder="Bill Name" required class="w-full px-4 py-2 rounded border dark:bg-gray-700 dark:text-white" />
      <input type="number" step="0.01" id="amount" placeholder="Amount" required class="w-full px-4 py-2 rounded border dark:bg-gray-700 dark:text-white" />
      <input type="number" id="due_day" placeholder="Due Day (1-31)" min="1" max="31" required class="w-full px-4 py-2 rounded border dark:bg-gray-700 dark:text-white" />
      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Save Bill</button>
    </form>

    <!-- Bill List -->
    <section class="bg-white dark:bg-gray-800 p-6 rounded shadow space-y-4">
      <h2 class="text-lg font-semibold dark:text-white">Your Bills</h2>
      <div id="bills-body" class="space-y-4"></div>
      <div id="monthly-total" class="text-right font-semibold text-green-600 dark:text-green-400 mt-4"></div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 inset-x-0 bg-white dark:bg-gray-800 border-t shadow-md flex justify-around py-2 z-50">
    <a href="dashboard.html" class="flex flex-col items-center text-sm dark:text-white">
      <span>🏠</span><span>Dashboard</span>
    </a>
    <a href="add-bill.html" class="flex flex-col items-center text-sm font-bold dark:text-white">
      <span>💸</span><span>Bills</span>
    </a>
    <a href="add-salary.html" class="flex flex-col items-center text-sm dark:text-white">
      <span>💼</span><span>Salary</span>
    </a>
    <a href="add-bonus.html" class="flex flex-col items-center text-sm dark:text-white">
      <span>🎁</span><span>Bonus</span>
    </a>
    <a href="settings.html" class="flex flex-col items-center text-sm dark:text-white">
      <span>⚙️</span><span>Settings</span>
    </a>
  </nav>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded shadow-lg hidden opacity-0 z-50 transition-all duration-300"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(
      'https://anwwjqupywbnwanuckdf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFud3dqcXVweXdibndhbnVja2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MzgxOTksImV4cCI6MjA2NTAxNDE5OX0.ExlSkJTP3mJ9u-7SVws0FYcNvlL9a4MJNsm8ZaK1X48'
    )

    const form = document.getElementById('bill-form')
    const editingId = document.getElementById('editing-id')
    const nameInput = document.getElementById('name')
    const amountInput = document.getElementById('amount')
    const dueDayInput = document.getElementById('due_day')
    const listContainer = document.getElementById('bills-body')
    const totalContainer = document.getElementById('monthly-total')

    function toggleTheme() {
      document.documentElement.classList.toggle('dark')
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light')
    }
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark')
    }

    function showToast(message, error = false) {
      const toast = document.getElementById('toast')
      toast.textContent = message
      toast.classList.remove('hidden', 'opacity-0')
      toast.classList.add('opacity-100', error ? 'bg-red-600' : 'bg-green-600')

      setTimeout(() => {
        toast.classList.add('opacity-0')
        setTimeout(() => toast.classList.add('hidden'), 300)
      }, 2000)
    }

    async function loadBills() {
      const { data: { user } } = await supabase.auth.getUser()
      const { data, error } = await supabase.from('bills').select('*').eq('user_id', user.id).order('due_day')

      listContainer.innerHTML = ''
      totalContainer.innerHTML = ''
      const now = new Date()
      const currentMonth = now.getMonth() + 1
      const currentYear = now.getFullYear()
      let totalAmount = 0

      if (data?.length > 0) {
        data.forEach(bill => {
          totalAmount += bill.amount
          const fullDate = `${currentMonth}/${bill.due_day}/${currentYear}`
          const item = document.createElement('div')
          item.className = "border rounded p-4 dark:border-gray-700 bg-gray-50 dark:bg-gray-700"
          item.innerHTML = `
            <div class="font-semibold text-lg dark:text-white">${bill.name}</div>
            <div class="text-sm text-gray-700 dark:text-gray-300 mt-1">
              Amount: $${bill.amount.toFixed(2)}<br />
              Due: ${fullDate}
            </div>
            <div class="mt-2">
              <button onclick="editBill('${bill.id}', '${bill.name}', ${bill.amount}, ${bill.due_day})" class="text-blue-600 hover:underline mr-4">Edit</button>
              <button onclick="deleteBill('${bill.id}')" class="text-red-600 hover:underline">Delete</button>
            </div>
          `
          listContainer.appendChild(item)
        })

        totalContainer.innerHTML = `Total Monthly Bills: $${totalAmount.toFixed(2)}`
      } else {
        listContainer.innerHTML = `<div class="text-gray-500 dark:text-gray-400 text-center">No bills found.</div>`
      }
    }

    window.editBill = (id, name, amount, due_day) => {
      editingId.value = id
      nameInput.value = name
      amountInput.value = amount
      dueDayInput.value = due_day
      window.scrollTo({ top: 0, behavior: 'smooth' })
    }

    window.deleteBill = async (id) => {
      const { error } = await supabase.from('bills').delete().eq('id', id)
      if (error) {
        showToast('Error deleting bill', true)
      } else {
        showToast('Bill deleted')
        loadBills()
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      const name = nameInput.value
      const amount = parseFloat(amountInput.value)
      const due_day = parseInt(dueDayInput.value)
      const { data: { user } } = await supabase.auth.getUser()

      let result
      if (editingId.value) {
        result = await supabase.from('bills').update({ name, amount, due_day }).eq('id', editingId.value)
      } else {
        result = await supabase.from('bills').insert([{ user_id: user.id, name, amount, due_day }])
      }

      if (result.error) {
        showToast('Error saving bill', true)
      } else {
        showToast(editingId.value ? 'Bill updated successfully!' : 'Bill added successfully!')
        form.reset()
        editingId.value = ''
        loadBills()
      }
    })

    loadBills()
  </script>
</body>
</html>