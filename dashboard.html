<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dashboard - Wealthwise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ========== TAILWIND & GOOGLE FONTS SECTION ========== -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
  <!-- Tailwind config must be set BEFORE loading the CDN script! -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'ww-dark-bg': '#1a2332',
            'ww-dark-card': '#232c3f',
            'ww-dark-text': '#e5e9f2',
            'ww-dark-accent': '#f3c96b',
            'ww-light-bg': '#f4f6fa',
            'ww-light-card': '#fff',
            'ww-light-text': '#22304a',
            'ww-light-secondary': '#51607a',
            'ww-light-accent': '#3157a1',
            'ww-light-accent-contrast': '#e2e9f3',
            'ww-accent-blue': '#2563eb',
            'ww-accent-blue-dark': '#1d4ed8',
            'ww-field-light': '#f9fafb',
            'ww-field-lighter': '#f3f4f6',
            'ww-light-yellow': '#FFD600',
            'ww-light-yellow-hover': '#FFC300',
          }
        }
      }
    }
  </script>
  <!-- ========== CSS SECTION ========== -->
  <style>
html, body {
  background: #f4f6fa;
  color: #22304a;
  font-family: 'Montserrat', Arial, sans-serif !important;
  transition: background 0.2s, color 0.2s;
  min-height: 100vh;
}
.dark body, body.dark {
  background: #1a2332 !important;
  color: #e5e9f2 !important;
}

/* User Avatar Dropdown */
.avatar-img-btn {
  background: none;
  border: none;
  padding: 0;
  margin: 0;
  display: flex;
  align-items: center;
  cursor: pointer;
  border-radius: 50%;
  position: relative;
  outline: none;
}
.avatar-img {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: 2px solid #2563eb;
  object-fit: cover;
  background: #fff;
  display: inline-block;
  vertical-align: middle;
}
.ww-user-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 110%;
  background: #fff;
  color: #1a2332;
  border: 1px solid #e2e9f3;
  border-radius: 0.7em;
  min-width: 220px;
  width: max-content;
  box-shadow: 0 8px 24px 0 rgba(49, 87, 161, 0.15);
  text-align: left;
  font-family: 'Montserrat', Arial, sans-serif;
  white-space: nowrap;
  z-index: 10000;
}
.dark .ww-user-dropdown {
  background: #232c3f !important;
  color: #e5e9f2 !important;
  border-color: #232c3f;
}
.ww-user-dropdown__profile {
  display: flex;
  align-items: center;
  padding: 1em 1.2em 0.8em 1.2em;
  border-bottom: 1px solid #e2e9f3;
  gap: 0.7em;
}
.ww-user-dropdown__profile-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #2563eb;
}
.dark .ww-user-dropdown__profile-avatar {
  border-color: #FFD600;
}
.ww-user-dropdown__profile-info {
  display: flex;
  flex-direction: column;
}
.ww-user-dropdown__profile-name {
  font-weight: 700;
  font-size: 1.14em;
  color: #2563eb;
  line-height: 1.1;
}
.dark .ww-user-dropdown__profile-name {
  color: #FFD600;
}
.ww-user-dropdown__profile-email {
  font-size: 0.97em;
  color: #51607a;
}
.dark .ww-user-dropdown__profile-email {
  color: #f3c96b;
}
.ww-user-dropdown button {
  width: 100%;
  text-align: left;
  padding: 0.85em 1.5em;
  background: none;
  border: none;
  font-weight: 600;
  font-size: 1em;
  cursor: pointer;
  color: #b91c1c;
  border-radius: 0 0 0.7em 0.7em;
  transition: background 0.15s, color 0.15s;
}
.dark .ww-user-dropdown button {
  color: #f87171;
}
.ww-user-dropdown button:hover {
  background: #f3f4f6;
  color: #b91c1c;
}
.dark .ww-user-dropdown button:hover {
  background: #1a2332 !important;
  color: #FFD600 !important;
}

/* Footer */
.footer-links a {
  margin: 0 0.6em;
  color: #FFD600;
  font-weight: bold;
  text-decoration: none;
  transition: color 0.18s;
}
.footer-links a:hover {
  color: #FFC300;
}
.dark .footer-links a, .dark .footer-links a:hover {
  color: #FFD600;
}

/* Responsive avatar/hamburger */
@media (max-width: 1024px) {
  #avatar-dropdown-btn { display: none !important; }
  #hamburger-btn { display: inline-flex !important; }
}
@media (min-width: 1025px) {
  #avatar-dropdown-btn { display: inline-flex !important; }
  #hamburger-btn { display: none !important; }
}

/* Card Styles (for legacy cards if any remain) */
.card {
  background: #fff;
  border-radius: 1em;
  box-shadow: 0 8px 32px 0 rgba(49, 87, 161, 0.14);
  padding: 2em 1.5em;
  margin-bottom: 2em;
  transition: background 0.2s, color 0.2s;
}
.dark .card {
  background: #232c3f !important;
  color: #e5e9f2 !important;
  box-shadow: 0 8px 32px 0 #232c3f22;
}

/* iPhone-style Cards (unified style for all main dashboard cards) */
.pro-card {
  background: linear-gradient(140deg, #2563eb 100%, #f4f6fa 100%);
  border-radius: 24px;
  box-shadow: 0 8px 32px 0 rgba(37,99,235,0.10), 0 2px 8px 0 rgba(49, 87, 161, 0.11);
  padding: 2.2em 1.5em 1.3em 1.5em;
  color: #fff;
  max-width: 410px;
  margin: 2em auto;
  position: relative;
  overflow: visible;
  border: none;
  font-size: 0.85em;
}
.pro-card .card-header {
  display: flex;
  align-items: center;
  margin-bottom: 1.6em;
}
.pro-card .card-header-icon {
  background: rgba(255,255,255,0.15);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  margin-right: 1em;
}
.pro-card .card-title {
  font-size: 1.16em;
  font-weight: 700;
  letter-spacing: 0.01em;
  color: #FFD600;
  margin-bottom: 0.15em;
  font-family: 'Montserrat', Arial, sans-serif;
}
.pro-card .card-actions {
  display: flex;
  gap: 16px;
  justify-content: flex-end;
  margin-bottom: 1.9em;
}
.pro-card .pro-icon-btn {
  background: rgba(255,255,255,0.18);
  border-radius: 15px;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  color: #fff;
  transition: background 0.15s, color 0.15s;
  position: relative;
  cursor: pointer;
  box-shadow: 0 2px 8px 0 #2563eb22;
}
.pro-card .pro-icon-btn:hover, .pro-card .pro-icon-btn:focus {
  background: #FFD600;
  color: #2563eb;
}
.pro-card .pro-icon-btn .toolt {
  opacity: 0;
  pointer-events: none;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: -38px;
  background: #232c3f;
  color: #fff;
  font-size: 0.97em;
  padding: 6px 14px;
  border-radius: 0.5em;
  white-space: nowrap;
  z-index: 10;
  transition: opacity 0.2s;
}
.pro-card .pro-icon-btn:hover .toolt, .pro-card .pro-icon-btn:focus .toolt {
  opacity: 1;
  pointer-events: auto;
}
.pro-card .card-section {
  background: rgba(255,255,255,0.18);
  border-radius: 1em;
  padding: 1.2em 1.2em 0.9em 1.2em;
  margin-bottom: 1.2em;
  box-shadow: 0 1px 6px 0 rgba(49, 87, 161, 0.07);
  color: #fff;
}
.pro-card .section-title {
  font-size: 1.08em;
  font-weight: 700;
  color: #FFD600;
  margin-bottom: 0.6em;
  letter-spacing: 0.01em;
  text-align: left;
}
.pro-card .section-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1.02em;
  margin-bottom: 0.35em;
}
.pro-card .section-label {
  font-weight: 600;
  color: #FFD600;
}
.pro-card .section-value {
  font-weight: 800;
  color: #fff;
  letter-spacing: 0.01em;
}
.pro-card .divider {
  border-bottom: 1.5px solid rgba(255,255,255,0.17);
  margin: 1.05em 0 0.9em 0;
}

/* Verse Card */
.verse-card {
  background: linear-gradient(90deg, #2563eb 100%, #f4f6fa 100%);
  color: #fff;
  border-radius: 1em;
  box-shadow: 0 4px 24px 0 #2563eb33;
  min-height: 120px;
  margin-bottom: 2em;
  padding: 1.7em 1.5em 1.2em 1.5em;
  position: relative;
  overflow: hidden;
}
/* .dark .verse-card {
  background: linear-gradient(90deg, #232c3f 70%, #1a2332 100%) !important;
  color: #f3c96b !important;
} */
.verse-ref {
  font-weight: 700;
  font-size: 1.08em;
  letter-spacing: 0.03em;
}
.verse-text {
  font-size: 1.1em;
  font-style: italic;
  margin: 0.7em 0 0.5em 0;
  color: #fff;
}
.dark .verse-text { color: #f3c96b !important; }
.verse-life {
  background: rgba(255,255,255,0.16);
  color: #fff;
  font-size: 0.97em;
  border-radius: 0.6em;
  padding: 0.5em 1em;
  margin-top: 0.5em;
  margin-bottom: 0.2em;
  display: inline-block;
}
/* .dark .verse-life {
  background: #232c3f;
  color: #f3c96b;
} */

/* Chart container */
.chart-container {
  width: 100%;
  height: 180px;
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

/* Bills List */
.bills-list li {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0.45em 0;
  flex-wrap: nowrap;
  overflow-x: auto;
}
.bills-list label {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  flex-wrap: nowrap;
  white-space: nowrap;
  overflow-x: auto;
}
.bills-list span.bill-name {
  flex: 1 1 0;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.bills-list span.bill-date {
  flex-shrink: 0;
  color: #22304a;
  font-size: 0.93em;
}
.bills-list span.bill-amount {
  flex-shrink: 0;
  font-weight: 600;
  margin-left: auto;
  color: #22304a;
}
.line-through { text-decoration: line-through; }
.bills-list li:not(:last-child) {
  border-bottom: 1px solid #e2e9f3;
}
.dark .bills-list li:not(:last-child) {
  border-bottom: 1px solid #3a4667;
}

.icon-circle {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #2563eb22;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 0.5em;
  color: #2563eb;
}
.dark .icon-circle {
  background: #f3c96b22;
  color: #f3c96b;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.37);
  z-index: 50;
  align-items: center;
  justify-content: center;
}
.modal.open { display: flex !important; }
.modal-content {
  background: #e3f0fb;
  border-radius: 1.5em;
  max-width: 98vw;
  width: 400px;
  max-height: 97vh;
  overflow: auto;
  padding: 2em 1.2em 1.2em 1.2em;
  position: relative;
  box-shadow: 0 8px 32px 0 rgba(49, 87, 161, 0.13);
  display: flex;
  flex-direction: column;
  animation: modalSlideUp 0.23s;
}
@keyframes modalSlideUp {
  from { transform: translateY(60px); opacity: 0.3;}
  to   { transform: translateY(0); opacity: 1;}
}
.dark .modal-content {
  background: #e3f0fb !important;
  color: #e5e9f2 !important;
  box-shadow: 0 8px 32px 0 #232c3f44;
}
.modal-close {
  position: absolute;
  right: 1.2em;
  top: 1.2em;
  cursor: pointer;
  font-size: 1.5em;
  color: #2563eb;
  background: none;
  border: none;
  z-index: 2;
}
.dark .modal-close { color: #f3c96b; }

/* Buttons */
.ww-btn {
  display: inline-block;
  background: #2563eb;
  color: #fff;
  padding: 0.7em 1.5em;
  border-radius: 0.5em;
  font-weight: 600;
  font-family: 'Montserrat', Arial, sans-serif;
  font-size: 1.07em;
  box-shadow: 0 4px 18px 0 #2563eb22;
  border: 1px solid #2563eb;
  cursor: pointer;
  letter-spacing: 0.03em;
  transition: background 0.18s, color 0.18s, border 0.18s;
}
.ww-btn:hover {
  background: #1d4ed8;
  color: #FFD600;
  border-color: #1d4ed8;
}

/* Responsive adjustments */
@media (max-width: 900px) {
  .flex-row {
    flex-direction: column !important;
  }
  .icon-row-btn { margin-bottom: 10px; }
  .pro-card, .card { padding: 1.4em 0.5em 1em 0.5em; }
}
@media (max-width: 500px) {
  #bills-modal .modal-content { padding: 1.2em 0.5em; }
  #bills-modal .bills-table-scroll { padding-right: 0; }
  #bills-modal .ios-table th,
  #bills-modal .ios-table td { font-size:0.97em;}
}
  </style>
  <script>
    // ========== DARK MODE INITIALIZER SECTION ==========
    (function() {
      let theme = localStorage.getItem('wealthwise-theme');
      if (!theme) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    })();
  </script>
</head>
<body class="min-h-screen flex flex-col text-ww-light-text dark:text-ww-dark-text transition-colors duration-200">

  <!-- ========== HEADER SECTION ========== -->
  <header class="bg-ww-dark-bg text-ww-dark-accent py-4 px-2 flex items-center w-full shadow-md flex-shrink-0 border-b border-ww-light-accent-contrast transition-colors duration-200" id="ww-header-bar">
    <a href="index.html" class="font-bold text-xl md:text-2xl tracking-wide logo-title block text-ww-light-yellow dark:text-ww-dark-accent ml-2" style="font-family:'Montserrat',Arial,sans-serif; text-decoration: none;">
      Wealthwise
    </a>
    <div class="ml-auto flex items-center gap-2" id="header-right">
      <!-- Theme Toggle -->
      <button id="theme-toggle" type="button" class="p-2 rounded-lg focus:outline-none transition hover:bg-ww-light-accent-contrast dark:hover:bg-ww-dark-card" title="Toggle dark/light mode">
        <svg class="w-6 h-6 text-ww-light-yellow dark:hidden" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="5" stroke="currentColor" fill="none"/>
          <path stroke-linecap="round" d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M16.36 16.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M16.36 7.64l1.42-1.42"/>
        </svg>
        <svg class="w-6 h-6 text-ww-dark-accent hidden dark:inline" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1111.21 3c.47 0 .94.03 1.41.08a7 7 0 008.3 9.71c.05.47.08.94.08 1.41z"/>
        </svg>
      </button>
      <!-- Avatar and Dropdown (desktop) -->
      <div style="position:relative;display:inline-block;">
        <button id="avatar-dropdown-btn" class="avatar-img-btn" tabindex="0" aria-haspopup="true" aria-expanded="false" style="padding:0;background:none;border:none;">
          <img id="user-avatar" class="avatar-img" src="" alt="User Avatar" style="display:none;" />
        </button>
        <button id="hamburger-btn" class="p-2 rounded-lg focus:outline-none transition bg-transparent" style="display:none;" aria-label="Menu">
          <!-- Hamburger Icon -->
          <svg class="w-8 h-8 text-ww-light-yellow dark:text-ww-dark-accent" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
            <line x1="4" y1="7" x2="20" y2="7" stroke-linecap="round"/>
            <line x1="4" y1="12" x2="20" y2="12" stroke-linecap="round"/>
            <line x1="4" y1="17" x2="20" y2="17" stroke-linecap="round"/>
          </svg>
        </button>
        <div class="ww-user-dropdown" id="avatar-dropdown-menu">
          <div class="ww-user-dropdown__profile" id="ww-dropdown-profile">
            <img class="ww-user-dropdown__profile-avatar" id="dropdown-profile-avatar" src="" alt="User Avatar" />
            <div class="ww-user-dropdown__profile-info">
              <span class="ww-user-dropdown__profile-name" id="dropdown-profile-name"></span>
              <span class="ww-user-dropdown__profile-email" id="dropdown-profile-email"></span>
            </div>
          </div>
          <button id="logout-btn" type="button" class="logout-btn">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ========== MAIN SECTION ========== -->
  <main class="flex flex-col items-center justify-center min-h-screen">
    <!-- Verse Card -->
    <div class="verse-card mt-8 mb-8 flex flex-col md:flex-row items-center">

      <div>
        <div class="verse-ref">Luke 16:10</div>
        <div class="verse-text">
          “Whoever can be trusted with very little can also be trusted with much...”
        </div>
        <div class="verse-life">
          <strong>Life Application:</strong>
          Faithfulness in small things builds the foundation for managing greater resources.<br>
          Start today by honoring God in every transaction and every minute.
        </div>
      </div>
    </div>
    <div class="flex flex-col md:flex-row gap-8 flex-row">
      <!-- Current Bank Balance Card (pro-card style) -->
      <div class="pro-card flex-1 min-w-0" id="bank-balance-card">
        <div class="card-header flex items-center mb-4">
          <div class="card-header-icon">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" d="M12 8v8m0 0c-4 0-8-2-8-6V6a2 2 0 012-2h12a2 2 0 012 2v4c0 4-4 6-8 6z"/>
            </svg>
          </div>
          <div>
            <div class="card-title">Current Financial Snapshot</div>
          </div>
        </div>
        <div class="card-section">
          <div class="section-title">Pay Period</div>
          <div class="section-row">
            <span class="section-label">Period</span>
            <span class="section-value" id="user-balance-period">Loading...</span>
          </div>
          <div class="divider"></div>
          <div class="section-title">Banking</div>
          <div class="section-row">
            <span class="section-label">Balance</span>
            <span class="section-value" id="user-balance-amount">$0.00</span>
<button
  id="open-allowances-modal-btn"
  class="ml-2 px-2 py-1 flex items-center gap-1 rounded-md border border-[#22304a] bg-[#22304a] text-white hover:bg-[#3157a1] dark:bg-ww-dark-card dark:border-ww-dark-accent dark:hover:bg-ww-dark-card"
  type="button"
  title="Update Bank & Allowances"
>
  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 20 20">
    <path stroke-linecap="round" stroke-linejoin="round" d="M7 7l3-3 3 3m0 6l-3 3-3-3"/>
  </svg>
  <span class="text-xs font-semibold">Edit</span>
</button>
          </div>
          <div class="section-row">
            <span class="section-label">Allowances</span>
            <span>
              <span id="user-food-allowance" class="section-value mr-2">Food: $0.00</span>
              <span id="user-fuel-allowance" class="section-value">Fuel: $0.00</span>
            </span>
          </div>
          <div class="divider"></div>
          <div class="section-title">Bills Due This Pay Period</div>
          <ul class="bills-list" id="user-balance-bills">
            <li>Loading bills...</li>
          </ul>
        </div>
      </div>
      <!-- 12-Month Balance Trends Card (pro-card style) -->
      <div class="pro-card flex-1 min-w-0">
        <div class="card-header flex items-center mb-4">
          <div class="card-header-icon">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" d="M3 17v-2a4 4 0 014-4h10a4 4 0 014 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </div>
          <div>
            <div class="card-title">Financial Forecast (12 Months)</div>
          </div>
        </div>
        <div class="card-section">
          <div class="section-title">High &amp; Low</div>
          <div class="section-row">
            <span class="section-label">12-mo High</span>
            <span class="section-value">$7,800.22</span>
          </div>
          <div class="section-row">
            <span class="section-label">12-mo Low</span>
            <span class="section-value">$2,120.44</span>
          </div>
          <div class="divider"></div>
          <div class="section-title">Trends</div>
          <div class="chart-container">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>
      <!-- Manage Bills, Allowances and Pay Card (Already pro-card style) -->
      <div class="pro-card flex-1 min-w-0" id="manage-bills-allowances-card">
        <div class="card-header">
          <div class="card-header-icon">
            <svg class="w-8 h-8 text-[#FFD600]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2v16z"/>
            </svg>
          </div>
          <div>
            <div class="card-title">Bills, Allowances &amp; Pay</div>
            <div class="text-[1.08em] text-white/80">Your upcoming period summary</div>
          </div>
        </div>
        <div class="card-actions">
          <button id="open-bills-modal-btn" class="pro-icon-btn group" type="button" tabindex="0">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
            </svg>
            <span class="toolt">Add / Delete Bills</span>
          </button>
          <button id="open-budget-allowances-modal-btn" class="pro-icon-btn group" type="button" tabindex="0">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <rect x="4" y="4" width="16" height="16" rx="4"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h8M12 8v8"/>
            </svg>
            <span class="toolt">Edit Allowances</span>
          </button>
          <button id="open-pay-modal-btn" class="pro-icon-btn group" type="button" tabindex="0">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18M12 3v18"/>
            </svg>
            <span class="toolt">Edit Pay</span>
          </button>
        </div>
        <div class="card-section">
          <div class="section-title">Bills &amp; Allowances</div>
          <div class="section-row">
            <span class="section-label">Total Bills</span>
            <span class="section-value" id="card-bills-count">0</span>
          </div>
          <div class="section-row">
            <span class="section-label">Bills Amount</span>
            <span class="section-value" id="card-bills-total">$0.00</span>
          </div>
          <div class="section-row">
            <span class="section-label">Allowances (Food &amp; Gas)</span>
            <span class="section-value" id="card-allowances-total">$0.00</span>
          </div>
          <div class="section-row" style="margin-top: 0.45em; border-top: 1px solid rgba(255,255,255,0.13); padding-top:0.7em;">
            <span class="section-label">Total Out</span>
            <span class="section-value" id="card-bills-allowances-sum">$0.00</span>
          </div>
        </div>
        <div class="divider"></div>
        <div class="card-section">
          <div class="section-title">Pay</div>
          <div class="section-row">
            <span class="section-label">Salary</span>
            <span class="section-value" id="card-salary-total">$0.00</span>
          </div>
          <div class="section-row">
            <span class="section-label">Frequency</span>
            <span class="section-value" id="card-salary-frequency">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Bills Modal -->
    <div id="bills-modal" class="modal">
      <div class="modal-content">
        <button class="absolute top-2 right-3 text-2xl" id="bills-modal-close">&times;</button>
        <form id="add-bill-form" class="mb-5">
          <input type="text" id="bill-name" required placeholder="Bill Name" class="border rounded px-2 py-1 w-full mb-2">
          <input type="number" id="bill-amount" required placeholder="Amount" class="border rounded px-2 py-1 w-full mb-2">
          <input type="date" id="bill-due-date" required class="border rounded px-2 py-1 w-full mb-2">
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded ios-btn">Add Bill</button>
        </form>
        <div class="modal-warning" id="bills-modal-warning"></div>
        <div class="font-bold mb-2">Your Bills</div>
        <form id="bills-delete-form">
          <div class="flex justify-between items-center mb-3">
            <label class="inline-flex items-center font-semibold text-xs cursor-pointer">
              <input type="checkbox" id="delete-bills-select-all" class="mr-2">
              Select All
            </label>
            <div class="flex gap-2">
              <button type="button" id="delete-bills-all-btn"
                class="ios-btn ios-btn-danger"
                style="min-width:90px; font-size:0.92em;">
                Delete All
              </button>
              <button type="submit" id="delete-bills-multi-btn"
                class="ios-btn ios-btn-danger"
                style="min-width:120px; font-size:0.92em;"
                disabled>
                Delete Selected
              </button>
            </div>
          </div>
          <div class="bills-table-scroll" style="max-width:100%;overflow-x:hidden;max-height:33vh;">
  <table class="ios-table" style="table-layout:fixed;width:100%;font-size:0.80em;">
    <colgroup>
      <col style="width:2em;">
      <col style="width:38%;">
      <col style="width:22%;">
      <col style="width:28%;">
      <col style="width:10%;">
    </colgroup>
    <thead>
                <tr>
                  <th style="width:2em"></th>
                  <th>Name</th>
                  <th class="text-right">Amount</th>
                  <th class="text-right">Due Date</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="bills-modal-table-body">
                <tr>
                  <td colspan="5" class="text-center">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </form>
      </div>
    </div>
    <!-- Allowances Modal -->
    <div id="budget-allowances-modal" class="modal">
      <div class="modal-content">
        <button class="absolute top-2 right-3 text-2xl" id="budget-allowances-modal-close">&times;</button>
        <div class="font-bold mb-4">Edit Allowances</div>
        <form id="budget-allowance-form">
          <label class="block mb-1 font-medium" for="budget-food-allowance">Food</label>
          <input type="number" min="0" step="0.01" id="budget-food-allowance" class="border rounded px-2 py-1 w-full mb-2" required>
          <label class="block mb-1 font-medium" for="budget-gas-allowance">Gas</label>
          <input type="number" min="0" step="0.01" id="budget-gas-allowance" class="border rounded px-2 py-1 w-full mb-2" required>
          <button type="submit" class="ww-btn w-full rounded-lg font-bold">Save Allowances</button>
        </form>
      </div>
    </div>
    <!-- Pay Modal -->
    <div id="pay-modal" class="modal">
      <div class="modal-content">
        <button class="absolute top-2 right-3 text-2xl" id="pay-modal-close">&times;</button>
        <div class="font-bold mb-4">Edit Pay</div>
        <form id="pay-form">
          <label class="block mb-1 font-medium" for="salary-amount">Salary</label>
          <input type="number" min="0" step="0.01" id="salary-amount" class="border rounded px-2 py-1 w-full mb-2" required>
          <label class="block mb-1 font-medium" for="salary-frequency">Pay Frequency</label>
          <select id="salary-frequency" class="border rounded px-2 py-1 w-full mb-2" required>
            <option value="">Select Frequency</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Biweekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <button type="submit" class="ios-btn w-full">Save Pay</button>
        </form>
      </div>
    </div>
	<!-- Allowances Modal -->
<div id="allowances-modal" class="modal">
  <div class="modal-content">
    <button class="modal-close" id="allowances-modal-close" type="button">&times;</button>
    <div class="font-bold mb-4">Edit Bank &amp; Allowances</div>
    <form id="bank-accounts-form">
      <label class="block mb-1 font-medium" for="bank-balance">Balance</label>
      <input type="number" min="0" step="0.01" id="bank-balance" class="border rounded px-2 py-1 w-full mb-2">
      <label class="block mb-1 font-medium" for="bank-pay-start-date">Pay Start Date</label>
      <input type="date" id="bank-pay-start-date" class="border rounded px-2 py-1 w-full mb-2">
      <label class="block mb-1 font-medium" for="bank-pay-frequency">Pay Frequency</label>
      <select id="bank-pay-frequency" class="border rounded px-2 py-1 w-full mb-2">
        <option value="">Select Frequency</option>
        <option value="weekly">Weekly</option>
        <option value="biweekly">Biweekly</option>
        <option value="monthly">Monthly</option>
      </select>
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded ios-btn">Save Bank Info</button>
    </form>
    <form id="allowance-form" class="mt-4">
      <label id="food-allowance-label" class="block mb-1 font-medium" for="food-allowance">Food Allowance</label>
      <input type="number" min="0" id="food-allowance" class="border rounded px-2 py-1 w-full mb-2">
      <label id="fuel-allowance-label" class="block mb-1 font-medium" for="fuel-allowance">Fuel Allowance</label>
      <input type="number" min="0" id="fuel-allowance" class="border rounded px-2 py-1 w-full mb-2">
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded ios-btn">Save Allowances</button>
    </form>
  </div>
</div>
  </main>

  <!-- ========== FOOTER SECTION ========== -->
  <footer class="text-center text-ww-dark-text bg-ww-dark-bg border-t border-ww-light-accent-contrast py-3 mt-auto w-full text-sm transition-colors duration-200">
    <div class="mb-1 footer-links">
      <a href="/terms-of-service.html?return=" id="footer-terms-link" class="mx-2 text-ww-light-yellow dark:text-ww-dark-accent font-bold hover:text-ww-light-yellow-hover dark:hover:text-ww-dark-accent transition-colors">Terms of Service</a>
      <a href="/privacy-policy/" class="mx-2 text-ww-light-yellow dark:text-ww-dark-accent font-bold hover:text-ww-light-yellow-hover dark:hover:text-ww-dark-accent transition-colors">Privacy Policy</a>
    </div>
    <div>&copy; 2025 Wealthwise. All rights reserved.</div>
  </footer>
  <!-- ========== HEADER/FOOTER/AVATAR SCRIPT ========== -->
<!-- Load Chart.js globally -->


const supabase = createClient(
  'https://anwwjqupywbnwanuckdf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFud3dqcXVweXdibndhbnVja2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MzgxOTksImV4cCI6MjA2NTAxNDE5OX0.ExlSkJTP3mJ9u-7SVws0FYcNvlL9a4MJNsm8ZaK1X48'
); 	
import Chart from "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js";
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
// ========== THEME TOGGLE LOGIC ==========
document.getElementById('theme-toggle').addEventListener('click', function() {
  const html = document.documentElement;
  const isDark = html.classList.contains('dark');
  if (isDark) {
    html.classList.remove('dark');
    localStorage.setItem('wealthwise-theme', 'light');
  } else {
    html.classList.add('dark');
    localStorage.setItem('wealthwise-theme', 'dark');
  }
});

// ========== SUPABASE PROFILE DROPDOWN LOGIC ==========
async function loadUserProfileDropdown() {
  const { data: { user }, error } = await supabase.auth.getUser();
  const avatarImg = document.getElementById('user-avatar');
  const avatarDropdownBtn = document.getElementById('avatar-dropdown-btn');
  const avatarDropdownMenu = document.getElementById('avatar-dropdown-menu');
  const dropdownProfileAvatar = document.getElementById('dropdown-profile-avatar');
  const dropdownProfileName = document.getElementById('dropdown-profile-name');
  const dropdownProfileEmail = document.getElementById('dropdown-profile-email');
  const logoutBtn = document.getElementById('logout-btn');

  // Hide everything if not logged in
  if (error || !user) {
    if (avatarImg) avatarImg.style.display = "none";
    if (avatarDropdownBtn) avatarDropdownBtn.style.display = "none";
    if (avatarDropdownMenu) avatarDropdownMenu.style.display = "none";
    document.getElementById('hamburger-btn').style.display = "none";
    return;
  }

  // Fetch profile for display name and avatar
  const { data: profile, error: profileError } = await supabase
    .from('profiles')
    .select('display_name, avatar_url')
    .eq('id', user.id)
    .single();

  let displayName = 'User';
  let avatarUrl = '';
  if (!profileError && profile) {
    displayName = profile.display_name || 'User';
    avatarUrl = profile.avatar_url || '';
    if (avatarImg && avatarUrl) avatarImg.src = avatarUrl;
    if (dropdownProfileAvatar && avatarUrl) dropdownProfileAvatar.src = avatarUrl;
    if (dropdownProfileName) dropdownProfileName.textContent = displayName;
    if (dropdownProfileEmail) dropdownProfileEmail.textContent = user.email || '';
  } else {
    if (avatarImg) avatarImg.src = "";
    if (dropdownProfileAvatar) dropdownProfileAvatar.src = "";
    if (dropdownProfileName) dropdownProfileName.textContent = "User";
    if (dropdownProfileEmail) dropdownProfileEmail.textContent = user.email || '';
  }

  // Show avatar button for desktop, hamburger for mobile/ipad
  if (avatarImg) avatarImg.style.display = "inline-block";
  if (avatarDropdownBtn) avatarDropdownBtn.style.display = "";
  const hamburgerBtn = document.getElementById('hamburger-btn');
  if (hamburgerBtn) hamburgerBtn.style.display = "";

  // Dropdown logic
  if (avatarDropdownBtn && avatarDropdownMenu) {
    let isOpen = false;
    const showDropdown = () => {
      avatarDropdownMenu.style.display = "block";
      avatarDropdownBtn.setAttribute("aria-expanded", "true");
      isOpen = true;
    };
    const hideDropdown = () => {
      avatarDropdownMenu.style.display = "none";
      avatarDropdownBtn.setAttribute("aria-expanded", "false");
      isOpen = false;
    };
    avatarDropdownBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      isOpen ? hideDropdown() : showDropdown();
    });
    avatarDropdownBtn.addEventListener('blur', () => {
      setTimeout(hideDropdown, 120);
    });
    avatarDropdownBtn.addEventListener('keydown', (e) => {
      if (e.key === "Escape") hideDropdown();
    });
    document.addEventListener('click', (e) => {
      if (isOpen && !avatarDropdownBtn.contains(e.target)) {
        hideDropdown();
      }
    });

    // Hamburger opens dropdown as well
    const hamburgerBtn = document.getElementById('hamburger-btn');
    if (hamburgerBtn) {
      hamburgerBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (avatarDropdownMenu.style.display === "block") {
          avatarDropdownMenu.style.display = "none";
        } else {
          avatarDropdownMenu.style.display = "block";
          // For accessibility, focus the first dropdown item
          const firstLink = avatarDropdownMenu.querySelector('button, a, input, [tabindex]:not([tabindex="-1"])');
          if (firstLink) firstLink.focus();
        }
      });
      document.addEventListener('click', (e) => {
        if (!avatarDropdownMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
          avatarDropdownMenu.style.display = "none";
        }
      });
    }
  }

  // Wire logout
  if (logoutBtn) {
    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      window.location.href = "/logout.html";
    };
  }
}

// ========== INIT ON LOAD ==========
document.addEventListener('DOMContentLoaded', () => {
  loadUserProfileDropdown();
  renderForecastTrendChart();
});
    function formatMoney(val) {
      return "$" + Number(val || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return d.toLocaleDateString(undefined, {year: 'numeric', month: 'long', day: 'numeric'});
    }
    function formatDateShort(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return d.toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
    }

    // --- DASHBOARD SNAPSHOT CARD ---
    async function loadCurrentBalanceCard() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        document.getElementById("user-balance-amount").textContent = "$0.00";
        document.getElementById("user-balance-period").textContent = "Not signed in";
        document.getElementById("user-food-allowance").textContent = "Food: $0.00";
        document.getElementById("user-fuel-allowance").textContent = "Fuel: $0.00";
        document.getElementById("user-balance-bills").innerHTML = "<li>Not signed in</li>";
        updateManageBillsAllowancesCard({bills:[],allowances:[]});
        return;
      }

      // Get latest balance snapshot and pay period
      const { data: balanceRows } = await supabase
        .from('user_balances')
        .select('total_remaining_balance,start_date,end_date')
        .eq('user_id', user.id)
        .order('end_date', { ascending: false })
        .limit(1);

      let balance = null;
      if (balanceRows && balanceRows.length > 0) {
        balance = balanceRows[0];
        document.getElementById("user-balance-amount").textContent =
          formatMoney(balance.total_remaining_balance || 0);
        document.getElementById("user-balance-period").textContent =
          formatDate(balance.start_date) + " - " + formatDate(balance.end_date);
      } else {
        document.getElementById("user-balance-amount").textContent = "$0.00";
        document.getElementById("user-balance-period").textContent = "No pay period found";
      }

      // Get Allowances (old table for card display)
      const { data: allowances } = await supabase
        .from('current_food_and_fuel_allowance')
        .select('allowance_name,amount')
        .eq('user_id', user.id);

      let foodAmt = 0, fuelAmt = 0;
      if (allowances && Array.isArray(allowances)) {
        const food = allowances.find(a => a.allowance_name.toLowerCase() === 'food');
        const fuel = allowances.find(a => a.allowance_name.toLowerCase() === 'fuel');
        foodAmt = food ? food.amount : 0;
        fuelAmt = fuel ? fuel.amount : 0;
      }
      document.getElementById("user-food-allowance").textContent = `Food: ${formatMoney(foodAmt)}`;
      document.getElementById("user-fuel-allowance").textContent = `Fuel: ${formatMoney(fuelAmt)}`;

      // Get bills for this pay period (SHOW ALL, regardless of paid status)
      let billsHtml = '<li>No bills found for this pay period.</li>';
      let billsForSummary = [];
      if (balance) {
        const { data: bills } = await supabase
          .from('bills')
          .select('id,bill_name,due_date,amount,is_paid')
          .eq('user_id', user.id)
          .gte('due_date', balance.start_date)
          .lte('due_date', balance.end_date)
          .order('due_date', { ascending: true });

        if (bills && bills.length > 0) {
          billsHtml = bills.map(bill => `
            <li>
              <label>
                <input 
                  type="checkbox" 
                  ${bill.is_paid ? "checked" : ""} 
                  data-bill-id="${bill.id}" 
                  onchange="window.handlePaidCheckboxChange && window.handlePaidCheckboxChange(event)"
                  style="accent-color: #2563eb; margin-right:6px;"
                >
                <span class="bill-name font-medium text-ww-accent-blue dark:text-ww-dark-accent ${bill.is_paid ? 'line-through text-gray-400' : ''}" title="${bill.bill_name}">${bill.bill_name}</span>
                <span class="bill-date ml-2 text-ww-light-secondary dark:text-ww-dark-accent">(${formatDateShort(bill.due_date)})</span>
                <span class="bill-amount font-semibold ml-auto">${formatMoney(bill.amount)}</span>
              </label>
            </li>
          `).join('');
          billsForSummary = bills;
        }
      }
      document.getElementById("user-balance-bills").innerHTML = billsHtml;

      // --- Update Manage Bills and Allowances Card (summary) ---
      // Fetch all bills for user for summary
      const { data: allBills } = await supabase
        .from('bills')
        .select('amount')
        .eq('user_id', user.id)
        .eq('record_type', 'original');
      // Fetch Food & Gas from budget_food_and_fuel_allowance_rows
      const { data: budgetAllowances } = await supabase
        .from('budget_food_and_fuel_allowance_rows')
        .select('allowance_name,amount')
        .eq('user_id', user.id);
      updateManageBillsAllowancesCard({bills: allBills || [], allowances: budgetAllowances || []});
    }
    window.loadCurrentBalanceCard = loadCurrentBalanceCard;
    loadCurrentBalanceCard();

    // --- Update Manage Bills and Allowances Card (summary) ---
    function updateManageBillsAllowancesCard({bills, allowances}) {
      // Bills
      const billsCount = bills.length;
      const billsTotal = bills.reduce((sum, b) => sum + (parseFloat(b.amount) || 0), 0);

      // Allowances (Food & Gas only)
      let totalAllowances = 0;
      allowances.forEach(a => {
        if (['food','gas'].includes((a.allowance_name || '').toLowerCase())) {
          totalAllowances += parseFloat(a.amount) || 0;
        }
      });
      const totalSum = billsTotal + totalAllowances;

      document.getElementById('card-bills-count').textContent = billsCount;
      document.getElementById('card-bills-total').textContent = formatMoney(billsTotal);
      document.getElementById('card-allowances-total').textContent = formatMoney(totalAllowances);
      document.getElementById('card-bills-allowances-sum').textContent = formatMoney(totalSum);
    }

    // --- PAID CHECKBOX HANDLER ---
    window.handlePaidCheckboxChange = async function(event) {
      const checkbox = event.target;
      const billId = checkbox.getAttribute('data-bill-id');
      if (!billId) return;
      const is_paid = !!checkbox.checked;
      const { error } = await supabase
        .from('bills')
        .update({ is_paid })
        .eq('id', billId);
      if (error) {
        alert("Error updating bill status: " + error.message);
        checkbox.checked = !is_paid;
      }
      await loadCurrentBalanceCard();
    };

    // --- ADD BILL MODAL LOGIC ---
    async function loadSummary() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        document.getElementById('card-bills-count').textContent = "0";
        document.getElementById('card-bills-total').textContent = "$0.00";
        document.getElementById('card-allowances-total').textContent = "$0.00";
        document.getElementById('card-bills-allowances-sum').textContent = "$0.00";
        document.getElementById('card-salary-total').textContent = "$0.00";
        document.getElementById('card-salary-frequency').textContent = "-";
        return;
      }
      // Bills
      const { data: bills } = await supabase.from('bills').select('id,amount').eq('user_id', user.id).eq('record_type', 'original');
      const billsCount = bills?.length || 0;
      const billsTotal = (bills||[]).reduce((sum, b) => sum + (parseFloat(b.amount) || 0), 0);
      // Allowances
      const { data: allowances } = await supabase.from('budget_food_and_fuel_allowance_rows').select('allowance_name,amount').eq('user_id', user.id);
      let allowancesTotal = 0;
      if (allowances) {
        for (const a of allowances) {
          if (['food','gas'].includes((a.allowance_name||'').toLowerCase())) {
            allowancesTotal += Number(a.amount)||0;
          }
        }
      }
      // Salary
      let salaryAmount = 0, payFrequency = "-";
      const { data: salaryRows } = await supabase.from('employee_salaries_rows').select('salary').eq('user_id', user.id).limit(1);
      if (salaryRows && salaryRows.length > 0) salaryAmount = salaryRows[0].salary || 0;
      const { data: bankRows } = await supabase.from('bank_accounts').select('pay_frequency').eq('user_id', user.id).limit(1);
      if (bankRows && bankRows.length > 0) payFrequency = bankRows[0].pay_frequency || "-";
      // Render
      document.getElementById('card-bills-count').textContent = billsCount;
      document.getElementById('card-bills-total').textContent = formatMoney(billsTotal);
      document.getElementById('card-allowances-total').textContent = formatMoney(allowancesTotal);
      document.getElementById('card-bills-allowances-sum').textContent = formatMoney(billsTotal + allowancesTotal);
      document.getElementById('card-salary-total').textContent = formatMoney(salaryAmount || 0);
      document.getElementById('card-salary-frequency').textContent = payFrequency || "-";
    }

    window.loadBillsModalTable = async function() {
      const { data: { user } } = await supabase.auth.getUser();
      const tbody = document.getElementById("bills-modal-table-body");
      if (!user) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-400">Not signed in.</td></tr>`;
        return;
      }
      const { data: bills, error } = await supabase
        .from('bills')
        .select('id,bill_name,amount,due_date')
        .eq('user_id', user.id)
        .eq('record_type', 'original')
        .order('due_date', { ascending: true });
      if (error) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-red-600">Error: ${error.message}</td></tr>`;
        return;
      }
      if (!bills || bills.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-400">No bills found.</td></tr>`;
        return;
      }
      tbody.innerHTML = bills.map(bill => `
        <tr>
          <td><input type="checkbox" class="delete-bill-checkbox" data-bill-id="${bill.id}"></td>
          <td>${bill.bill_name}</td>
          <td class="text-right">${formatMoney(bill.amount)}</td>
          <td class="text-right">${formatDate(bill.due_date)}</td>
          <td class="text-right">
            <button type="button"
  class="inline-flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 text-red-500 hover:text-red-600 transition w-7 h-7"
  aria-label="Delete"
  onclick="window.deleteSingleBill('${bill.id}')">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 20 20" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M6.5 6.5l7 7m0-7l-7 7" />
  </svg>
</button>
          </td>
        </tr>
      `).join('');
      setupDeleteBillsCheckboxLogic();
    };

    window.deleteSingleBill = async function(billId) {
      if (!billId) return;
      if (!confirm("Delete this bill?")) return;
      await supabase.from('bills').delete().eq('id', billId);
      await window.loadBillsModalTable();
      await loadSummary();
    };

    // Multiple and Select All Delete Logic
    function setupDeleteBillsCheckboxLogic() {
      const checkboxes = Array.from(document.querySelectorAll('.delete-bill-checkbox'));
      const selectAll = document.getElementById('delete-bills-select-all');
      const deleteBtn = document.getElementById('delete-bills-multi-btn');
      const deleteAllBtn = document.getElementById('delete-bills-all-btn');
      const warningDiv = document.getElementById('bills-modal-warning');

      function showWarning(msg) {
        warningDiv.textContent = msg;
        warningDiv.classList.add('open');
        setTimeout(() => warningDiv.classList.remove('open'), 4500);
      }
      function updateButtons() {
        const anyChecked = checkboxes.some(cb => cb.checked);
        deleteBtn.disabled = !anyChecked;
        selectAll.checked = checkboxes.length > 0 && checkboxes.every(cb => cb.checked);
      }
      checkboxes.forEach(cb => cb.addEventListener('change', updateButtons));
      selectAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateButtons();
      });
      updateButtons();
      // Delete All
      deleteAllBtn.onclick = async function(e) {
        e.preventDefault();
        if (!checkboxes.length) return;
        showWarning('Are you sure? This will permanently delete ALL your bills. Click Delete All again to confirm.');
        deleteAllBtn.onclick = async function(e2) {
          e2.preventDefault();
          const allIds = checkboxes.map(cb => cb.getAttribute('data-bill-id'));
          await supabase.from('bills').delete().in('id', allIds);
          await window.loadBillsModalTable();
          await loadSummary();
          warningDiv.textContent = '';
          warningDiv.classList.remove('open');
          // re-attach confirm handler
          setupDeleteBillsCheckboxLogic();
        };
      };
    }

    document.getElementById('bills-delete-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const warningDiv = document.getElementById('bills-modal-warning');
      const checkedBoxes = Array.from(document.querySelectorAll('.delete-bill-checkbox:checked'));
      if (checkedBoxes.length === 0) return;
      warningDiv.textContent = `Are you sure? This will permanently delete ${checkedBoxes.length} selected bill(s). Click Delete Selected again to confirm.`;
      warningDiv.classList.add('open');
      // double submit to confirm
      this.onsubmit = async function(e2) {
        e2.preventDefault();
        const ids = checkedBoxes.map(cb => cb.getAttribute('data-bill-id'));
        await supabase.from('bills').delete().in('id', ids);
        await window.loadBillsModalTable();
        await loadSummary();
        warningDiv.textContent = '';
        warningDiv.classList.remove('open');
        // re-attach original handler
        this.onsubmit = null;
      };
    });

    document.getElementById("open-bills-modal-btn").addEventListener("click", () => {
      document.getElementById("bills-modal").classList.add("open");
      window.loadBillsModalTable();
      document.getElementById("bills-modal-warning").textContent = '';
      document.getElementById("bills-modal-warning").classList.remove('open');
    });
    document.getElementById("bills-modal-close").addEventListener("click", () => {
      document.getElementById("bills-modal").classList.remove("open");
    });

    document.getElementById("add-bill-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert("You must be logged in to add a bill.");
        return;
      }
      const bill_name = document.getElementById("bill-name").value.trim();
      const amount = parseFloat(document.getElementById("bill-amount").value);
      const due_date = document.getElementById("bill-due-date").value;
      if (!bill_name || isNaN(amount) || !due_date) {
        alert("Please fill out all fields.");
        return;
      }
      await supabase.from('bills').insert([{
        user_id: user.id,
        bill_name,
        amount,
        due_date,
        record_type: 'original'
      }]);
      document.getElementById("add-bill-form").reset();
      window.loadBillsModalTable();
      loadSummary();
    });

    // ALLOWANCES MODAL LOGIC
    document.getElementById("open-budget-allowances-modal-btn").addEventListener("click", () => {
      document.getElementById("budget-allowances-modal").classList.add("open");
      loadBudgetAllowancesData();
    });
    document.getElementById("budget-allowances-modal-close").addEventListener("click", () => {
      document.getElementById("budget-allowances-modal").classList.remove("open");
    });

    async function loadBudgetAllowancesData() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { data: allowances } = await supabase
        .from('budget_food_and_fuel_allowance_rows')
        .select('id,allowance_name,amount')
        .eq('user_id', user.id);
      let food = allowances && allowances.find(a => a.allowance_name.toLowerCase() === 'food');
      let gas = allowances && allowances.find(a => a.allowance_name.toLowerCase() === 'gas');
      document.getElementById("budget-food-allowance").value = food ? food.amount : '';
      document.getElementById("budget-gas-allowance").value = gas ? gas.amount : '';
      document.getElementById("budget-food-allowance").dataset.allowanceId = food ? food.id : '';
      document.getElementById("budget-gas-allowance").dataset.allowanceId = gas ? gas.id : '';
    }

    document.getElementById("budget-allowance-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const foodAmount = parseFloat(document.getElementById("budget-food-allowance").value) || 0;
      const foodId = document.getElementById("budget-food-allowance").dataset.allowanceId;
      if (foodId) {
        await supabase.from('budget_food_and_fuel_allowance_rows')
          .update({ amount: foodAmount })
          .eq('id', foodId);
      } else {
        await supabase.from('budget_food_and_fuel_allowance_rows')
          .insert([{ user_id: user.id, allowance_name: 'Food', amount: foodAmount }]);
      }
      const gasAmount = parseFloat(document.getElementById("budget-gas-allowance").value) || 0;
      const gasId = document.getElementById("budget-gas-allowance").dataset.allowanceId;
      if (gasId) {
        await supabase.from('budget_food_and_fuel_allowance_rows')
          .update({ amount: gasAmount })
          .eq('id', gasId);
      } else {
        await supabase.from('budget_food_and_fuel_allowance_rows')
          .insert([{ user_id: user.id, allowance_name: 'Gas', amount: gasAmount }]);
      }
      alert("Food & Gas updated!");
      document.getElementById("budget-allowances-modal").classList.remove("open");
      await loadSummary();
    });

    // PAY MODAL LOGIC
    document.getElementById("open-pay-modal-btn").addEventListener("click", () => {
      document.getElementById("pay-modal").classList.add("open");
      loadPayModalData();
    });
    document.getElementById("pay-modal-close").addEventListener("click", () => {
      document.getElementById("pay-modal").classList.remove("open");
    });

    async function loadPayModalData() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      let salary = "";
      let salaryId = "";
      const { data: salaryRows } = await supabase
        .from('employee_salaries_rows')
        .select('id,salary')
        .eq('user_id', user.id)
        .limit(1);
      if (salaryRows && salaryRows.length > 0) {
        salary = salaryRows[0].salary || "";
        salaryId = salaryRows[0].id || "";
      }
      document.getElementById("salary-amount").value = salary;
      document.getElementById("salary-amount").dataset.salaryId = salaryId;
      let payFrequency = "";
      let bankId = "";
      const { data: bankRows } = await supabase
        .from('bank_accounts')
        .select('id,pay_frequency')
        .eq('user_id', user.id)
        .limit(1);
      if (bankRows && bankRows.length > 0) {
        payFrequency = bankRows[0].pay_frequency || "";
        bankId = bankRows[0].id || "";
      }
      document.getElementById("salary-frequency").value = payFrequency;
      document.getElementById("salary-frequency").dataset.bankId = bankId;
    }

    document.getElementById("pay-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const salary = parseFloat(document.getElementById("salary-amount").value) || 0;
      const salaryId = document.getElementById("salary-amount").dataset.salaryId;
      const payFrequency = document.getElementById("salary-frequency").value;
      const bankId = document.getElementById("salary-frequency").dataset.bankId;

      if (salaryId) {
        await supabase.from('employee_salaries_rows')
          .update({ salary })
          .eq('id', salaryId);
      } else {
        await supabase.from('employee_salaries_rows')
          .insert([{ user_id: user.id, salary }]);
      }
      if (bankId) {
        await supabase.from('bank_accounts')
          .update({ pay_frequency: payFrequency })
          .eq('id', bankId);
      } else {
        await supabase.from('bank_accounts')
          .insert([{ user_id: user.id, pay_frequency: payFrequency }]);
      }
      alert("Pay updated!");
      document.getElementById("pay-modal").classList.remove("open");
      await loadSummary();
    });

    // On page load, update summary
    loadSummary();

// --- ALLOWANCES MODAL LOGIC ---
let loggedInUser = null;
async function fetchUserAllowances() {
  if (loggedInUser) return loggedInUser;
  const { data: { user } } = await supabase.auth.getUser();
  loggedInUser = user;
  return user;
}
function closeAllowancesModal() {
  document.getElementById("allowances-modal").classList.remove("open");
}
function openAllowancesModal() {
  document.getElementById("allowances-modal").classList.add("open");
  loadAllowancesData();
}
const openAllowancesModalBtn = document.getElementById("open-allowances-modal-btn");
if (openAllowancesModalBtn) {
  openAllowancesModalBtn.addEventListener("click", openAllowancesModal);
}
document.getElementById("allowances-modal-close").addEventListener("click", closeAllowancesModal);
document.getElementById("allowances-modal").addEventListener("click", function(e) {
  if (e.target === this) closeAllowancesModal();
});
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") closeAllowancesModal();
});

async function loadAllowancesData() {
  const user = await fetchUserAllowances();
  if (!user) return;
  const { data: bank } = await supabase
    .from('bank_accounts')
    .select('id,balance,pay_start_date,pay_frequency')
    .eq('user_id', user.id)
    .limit(1)
    .single();
  if (bank) {
    document.getElementById("bank-balance").value = bank.balance || '';
    document.getElementById("bank-pay-start-date").value = bank.pay_start_date || '';
    document.getElementById("bank-pay-frequency").value = bank.pay_frequency || '';
    document.getElementById("bank-accounts-form").dataset.bankId = bank.id || '';
  } else {
    document.getElementById("bank-balance").value = '';
    document.getElementById("bank-pay-start-date").value = '';
    document.getElementById("bank-pay-frequency").value = '';
    document.getElementById("bank-accounts-form").dataset.bankId = '';
  }
  const { data: allowances } = await supabase
    .from('current_food_and_fuel_allowance')
    .select('id,allowance_name,amount')
    .eq('user_id', user.id);

  let food = null, fuel = null;
  if (allowances && Array.isArray(allowances)) {
    food = allowances.find(a => a.allowance_name.toLowerCase() === 'food');
    fuel = allowances.find(a => a.allowance_name.toLowerCase() === 'fuel');
  }
  document.getElementById("food-allowance").value = food ? food.amount : '';
  document.getElementById("fuel-allowance").value = fuel ? fuel.amount : '';
  document.getElementById("food-allowance-label").innerText =
      `Food Allowance (${formatMoney(food ? food.amount : 0)})`;
  document.getElementById("fuel-allowance-label").innerText =
      `Fuel Allowance (${formatMoney(fuel ? fuel.amount : 0)})`;
  if (food) document.getElementById("allowance-form").dataset.foodId = food.id;
  else document.getElementById("allowance-form").dataset.foodId = '';
  if (fuel) document.getElementById("allowance-form").dataset.fuelId = fuel.id;
  else document.getElementById("allowance-form").dataset.fuelId = '';
}

document.getElementById("bank-accounts-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const user = await fetchUserAllowances();
  if (!user) return;
  const balance = parseFloat(document.getElementById("bank-balance").value);
  const pay_start_date = document.getElementById("bank-pay-start-date").value;
  const pay_frequency = document.getElementById("bank-pay-frequency").value;
  const bankId = e.target.dataset.bankId;

  let updateObj = {
    balance,
    pay_start_date,
    pay_frequency,
    user_id: user.id
  };

  if (bankId) {
    const { error } = await supabase.from('bank_accounts').update(updateObj).eq('id', bankId);
    if (error) return alert("Error updating bank account: " + error.message);
    alert("Bank account updated!");
  } else {
    const { error } = await supabase.from('bank_accounts').insert([updateObj]);
    if (error) return alert("Error creating bank account: " + error.message);
    alert("Bank account created!");
  }
  closeAllowancesModal();
  await loadCurrentBalanceCard();
});

// Robust upsert for food & fuel
document.getElementById("allowance-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const user = await fetchUserAllowances();
  if (!user) return;
  const foodAmount = parseFloat(document.getElementById("food-allowance").value) || 0;
  const fuelAmount = parseFloat(document.getElementById("fuel-allowance").value) || 0;
  const foodId = e.target.dataset.foodId;
  const fuelId = e.target.dataset.fuelId;

  if (foodId) {
    const { data, error } = await supabase.from('current_food_and_fuel_allowance')
      .update({ amount: foodAmount })
      .eq('id', foodId)
      .select();
    if (error) return alert("Error updating food allowance: " + error.message);
    if (!data || data.length === 0) {
      await supabase.from('current_food_and_fuel_allowance')
        .insert([{ user_id: user.id, allowance_name: 'Food', amount: foodAmount }]);
    }
  } else {
    await supabase.from('current_food_and_fuel_allowance')
      .insert([{ user_id: user.id, allowance_name: 'Food', amount: foodAmount }]);
  }
  if (fuelId) {
    const { data, error } = await supabase.from('current_food_and_fuel_allowance')
      .update({ amount: fuelAmount })
      .eq('id', fuelId)
      .select();
    if (error) return alert("Error updating fuel allowance: " + error.message);
    if (!data || data.length === 0) {
      await supabase.from('current_food_and_fuel_allowance')
        .insert([{ user_id: user.id, allowance_name: 'Fuel', amount: fuelAmount }]);
    }
  } else {
    await supabase.from('current_food_and_fuel_allowance')
      .insert([{ user_id: user.id, allowance_name: 'Fuel', amount: fuelAmount }]);
  }

  alert("Allowances updated!");
  closeAllowancesModal();
  await loadAllowancesData();
});
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
// Place this <script type="module"> block after Chart.js and after DOMContentLoaded

wwindow.renderForecastTrendChart = async function() {
  // Get current user
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;

  // Query 12-month forecast for this user
  const { data: forecast, error } = await supabase
    .from('pay_cycle_forecast')
    .select('cycle_number, pay_cycle_start, total_remaining_balance')
    .eq('user_id', user.id)
    .order('cycle_number', { ascending: true });

  const chartEl = document.getElementById('trendChart');
  if (!chartEl) return;

  if (error || !forecast || forecast.length === 0) {
    chartEl.parentElement.innerHTML = "<div class='text-center text-gray-500'>No forecast data available.</div>";
    return;
  }

  // Prepare data for chart
  const labels = forecast.map(row => {
    if (row.pay_cycle_start) {
      const d = new Date(row.pay_cycle_start);
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }
    return `Cycle ${row.cycle_number}`;
  });
  const data = forecast.map(row => row.total_remaining_balance);

  // Find high/low for card (and update card values if you want)
  const max = Math.max(...data);
  const min = Math.min(...data);

  // Update the two "High" and "Low" values in the card
  const sectionRows = document.querySelectorAll('.pro-card .section-row');
  sectionRows.forEach(row => {
    if (row.querySelector('.section-label')?.textContent?.includes('12-mo High')) {
      row.querySelector('.section-value').textContent = "$" + max.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    if (row.querySelector('.section-label')?.textContent?.includes('12-mo Low')) {
      row.querySelector('.section-value').textContent = "$" + min.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }
  });

  // Destroy any existing chart instance on this element to avoid overlay
  if (window.trendChartInstance) {
    window.trendChartInstance.destroy();
  }

  const ctxTrend = chartEl.getContext('2d');
  window.trendChartInstance = new Chart(ctxTrend, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Projected Balance',
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37,99,235,0.08)',
        data,
        fill: true,
        tension: 0.28,
        pointRadius: 3,
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: false, grid: { color: '#e2e9f3' } },
        x: { grid: { display: false } }
      }
    }
  });
};

// Replace old static chart usage with dynamic one
document.addEventListener('DOMContentLoaded', () => {
  window.renderForecastTrendChart();
});
  </script>
  <script type="module" src="dashboard.js"></script>
</body>
</html>
