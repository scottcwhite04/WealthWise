<!DOCTYPE html>
<html lang="en" class="bg-gray-100 dark:bg-gray-900">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen p-4 text-gray-800 dark:text-white">
  <!-- Finances Display -->
  <div id="financeView" class="max-w-xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md cursor-pointer" onclick="openFinanceForm()">
    <h2 class="text-xl font-bold mb-2">Your Finances</h2>
    <p>Balance: $<span id="balanceDisplay">1000.00</span></p>
    <p>Pay Frequency: <span id="frequencyDisplay">biweekly</span></p>
    <p>Food Allowance: $<span id="foodDisplay">250.00</span></p>
    <p>Fuel Allowance: $<span id="fuelDisplay">150.00</span></p>
    <p>Start Date: <span id="startDateDisplay">2025-07-31</span></p>
  </div>

  <!-- Editable Form -->
  <div id="financeForm" class="max-w-xl mx-auto bg-white dark:bg-gray-800 p-6 mt-4 rounded-lg shadow-md hidden">
    <h2 class="text-xl font-bold mb-4">Edit Finances</h2>
    <form id="saveFinanceForm" class="space-y-4">
      <div>
        <label class="block mb-1">Current Balance</label>
        <input id="balanceInput" type="text" class="w-full p-2 border rounded text-gray-800 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" />
      </div>
      <div>
        <label class="block mb-1">Pay Frequency</label>
        <select id="frequencyInput" class="w-full p-2 border rounded text-gray-800 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600">
          <option value="weekly">Weekly</option>
          <option value="biweekly">Biweekly</option>
          <option value="semimonthly">Semi-Monthly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
      <div>
        <label class="block mb-1">Food Allowance</label>
        <input id="foodInput" type="text" class="w-full p-2 border rounded text-gray-800 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" />
      </div>
      <div>
        <label class="block mb-1">Fuel Allowance</label>
        <input id="fuelInput" type="text" class="w-full p-2 border rounded text-gray-800 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" />
      </div>
      <div>
        <label class="block mb-1">Pay Start Date</label>
        <input id="startDatePicker" type="date" class="w-full p-2 border rounded text-gray-800 dark:text-white bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" />
      </div>
      <div class="flex justify-between pt-2">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save</button>
        <button type="button" onclick="cancelEdit()" class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded shadow-lg hidden"></div>

  <!-- Script -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://anwwjqupywbnwanuckdf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFud3dqcXVweXdibndhbnVja2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MzgxOTksImV4cCI6MjA2NTAxNDE5OX0.ExlSkJTP3mJ9u-7SVws0FYcNvlL9a4MJNsm8ZaK1X48'
    );

    const user = await supabase.auth.getUser();
    const userId = user?.data?.user?.id;
    if (!userId) alert('Not logged in');

    const balanceDisplay = document.getElementById('balanceDisplay');
    const frequencyDisplay = document.getElementById('frequencyDisplay');
    const foodDisplay = document.getElementById('foodDisplay');
    const fuelDisplay = document.getElementById('fuelDisplay');
    const startDateDisplay = document.getElementById('startDateDisplay');

    const balanceInput = document.getElementById('balanceInput');
    const frequencyInput = document.getElementById('frequencyInput');
    const foodInput = document.getElementById('foodInput');
    const fuelInput = document.getElementById('fuelInput');
    const startDatePicker = document.getElementById('startDatePicker');

    const financeView = document.getElementById('financeView');
    const financeForm = document.getElementById('financeForm');
    const toast = document.getElementById('toast');

    function formatCurrency(value) {
      const num = parseFloat(value.replace(/[^\d.]/g, ''));
      return isNaN(num) ? '' : num.toFixed(2);
    }

    function attachFormatting(input) {
      input.addEventListener('input', () => {
        const cursorPos = input.selectionStart;
        const formatted = formatCurrency(input.value);
        input.value = formatted;
        input.setSelectionRange(cursorPos, cursorPos); // keeps caret position
      });
    }

    attachFormatting(balanceInput);
    attachFormatting(foodInput);
    attachFormatting(fuelInput);

    function openFinanceForm() {
      financeView.classList.add('hidden');
      financeForm.classList.remove('hidden');

      balanceInput.value = balanceDisplay.textContent;
      frequencyInput.value = frequencyDisplay.textContent.toLowerCase();
      foodInput.value = foodDisplay.textContent;
      fuelInput.value = fuelDisplay.textContent;
      startDatePicker.value = startDateDisplay.textContent;
    }

    function cancelEdit() {
      financeForm.classList.add('hidden');
      financeView.classList.remove('hidden');
    }

    document.getElementById('saveFinanceForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const balanceVal = parseFloat(balanceInput.value);
      const foodVal = parseFloat(foodInput.value);
      const fuelVal = parseFloat(fuelInput.value);
      const startDateVal = startDatePicker.value;

      if (
        isNaN(balanceVal) || balanceVal < 0 ||
        isNaN(foodVal) || foodVal < 0 ||
        isNaN(fuelVal) || fuelVal < 0 ||
        !startDateVal
      ) {
        showToast('Please fill in all fields with valid numbers', true);
        return;
      }

      const updates = {
        user_id: userId,
        current_balance: balanceVal,
        pay_frequency: frequencyInput.value,
        food_allowance: foodVal,
        fuel_allowance: fuelVal,
        payStartDate: startDateVal
      };

      const { error } = await supabase
        .from('balances')
        .upsert(updates, { onConflict: ['user_id'] });

      if (error) {
        showToast('Error saving preferences', true);
        return;
      }

      balanceDisplay.textContent = balanceVal.toFixed(2);
      frequencyDisplay.textContent = updates.pay_frequency;
      foodDisplay.textContent = foodVal.toFixed(2);
      fuelDisplay.textContent = fuelVal.toFixed(2);
      startDateDisplay.textContent = updates.payStartDate;

      financeForm.classList.add('hidden');
      financeView.classList.remove('hidden');

      showToast('Preferences saved successfully');
    });

    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg ${
        isError ? 'bg-red-600' : 'bg-green-600'
      } text-white`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
  </script>
</body>
</html>