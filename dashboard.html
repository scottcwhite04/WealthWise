<!DOCTYPE html>
<html lang="en" class="bg-gray-100 dark:bg-gray-900">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WealthWise Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="text-gray-800 dark:text-white">

  <!-- Header -->
  <header class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 shadow">
    <h1 class="text-xl font-semibold">Dashboard</h1>
    <button id="menu-toggle" class="text-2xl">&#9776;</button>
  </header>

  <main class="p-4 space-y-6">

    <!-- Inline Editable Financial Preferences Card -->
    <div id="financeCard" class="bg-white dark:bg-gray-800 rounded shadow p-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition">
      <h2 class="text-lg font-semibold mb-2">Your Finances</h2>
      <div id="financeView" class="space-y-1">
        <p>Balance: $<span id="balanceDisplay"></span></p>
        <p>Pay Frequency: <span id="frequencyDisplay"></span></p>
        <p>Food Allowance: $<span id="foodDisplay"></span></p>
        <p>Fuel Allowance: $<span id="fuelDisplay"></span></p>
      </div>

      <form id="financeForm" class="space-y-2 hidden">
        <input id="balanceInput" type="number" step="0.01" class="w-full p-2 border rounded" placeholder="Current Balance" />
        <select id="frequencyInput" class="w-full p-2 border rounded">
          <option value="weekly">Weekly</option>
          <option value="biweekly">Biweekly</option>
          <option value="semi-monthly">Semi-Monthly</option>
          <option value="monthly">Monthly</option>
        </select>
        <input id="foodInput" type="number" step="0.01" class="w-full p-2 border rounded" placeholder="Food Allowance" />
        <input id="fuelInput" type="number" step="0.01" class="w-full p-2 border rounded" placeholder="Fuel Allowance" />
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </form>
    </div>

    <!-- Inline Date Picker -->
    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
      <label for="startDatePicker" class="block mb-2 font-medium">Select Pay Start Date:</label>
      <input type="date" id="startDatePicker" class="w-full p-2 border rounded" />
    </div>

    <!-- Toggle Projections -->
    <div class="flex justify-between items-center">
      <h2 class="text-lg font-semibold">Pay Cycle Projections</h2>
      <button id="toggleProjections" class="text-blue-600 underline">Hide</button>
    </div>

    <div id="projectionsContainer" class="space-y-2">
      <!-- Projections will be injected here -->
    </div>

    <!-- Summary -->
    <div id="summary" class="text-sm text-gray-600 dark:text-gray-300"></div>

    <!-- Chart.js Monthly Summary -->
    <div class="bg-white dark:bg-gray-800 rounded p-4 shadow">
      <h2 class="text-lg font-semibold mb-2">Monthly Balance Trend</h2>
      <canvas id="monthlyChart"></canvas>
    </div>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';

    const SUPABASE_URL = 'https://anwwjqupywbnwanuckdf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFud3dqcXVweXdibndhbnVja2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MzgxOTksImV4cCI6MjA2NTAxNDE5OX0.ExlSkJTP3mJ9u-7SVws0FYcNvlL9a4MJNsm8ZaK1X48';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const userId = (await supabase.auth.getUser()).data.user.id;

    let currentStartDate = null;
    let currentFrequency = 'biweekly';
    let currentBalance = 0;
    let allBills = [];

    async function loadData() {
      const { data: balances } = await supabase
        .from('balances')
        .select('*')
        .eq('user_id', userId)
        .single();

      if (!balances) return;

      currentBalance = parseFloat(balances.current_balance);
      currentFrequency = balances.pay_frequency;
      currentStartDate = new Date(balances.payStartDate);
      document.getElementById('startDatePicker').value = currentStartDate.toISOString().slice(0, 10);

      document.getElementById('balanceDisplay').textContent = currentBalance.toFixed(2);
      document.getElementById('frequencyDisplay').textContent = currentFrequency;
      document.getElementById('foodDisplay').textContent = parseFloat(balances.food_allowance).toFixed(2);
      document.getElementById('fuelDisplay').textContent = parseFloat(balances.fuel_allowance).toFixed(2);

      const { data: bills } = await supabase
        .from('bills')
        .select('*')
        .eq('user_id', userId);
      allBills = bills || [];

      generateProjections();
    }

    function getNextCycle(startDate, freq, count) {
      const dates = [];
      const base = new Date(startDate);
      const cycles = { weekly: 7, biweekly: 14, 'semi-monthly': 15, monthly: 30 };
      const max = { weekly: 20, biweekly: 15, 'semi-monthly': 15, monthly: 10 }[freq];

      let balance = currentBalance;
      let monthlySums = {};

      for (let i = 0; i < max; i++) {
        let end = new Date(base);
        if (freq === 'semi-monthly') {
          end.setDate(end.getDate() + (i % 2 === 0 ? 15 : 14));
        } else {
          end.setDate(end.getDate() + (cycles[freq] * i));
        }

        let nextEnd = new Date(end);
        nextEnd.setDate(nextEnd.getDate() + (freq === 'semi-monthly' ? 14 : cycles[freq]));

        const dueBills = allBills.filter(b => {
          const due = new Date(end.getFullYear(), end.getMonth(), b.due_day);
          return due >= end && due < nextEnd;
        });

        const billTotal = dueBills.reduce((sum, b) => sum + parseFloat(b.amount), 0);
        balance -= billTotal;

        const warning = balance < 0 ? 'text-red-600' : balance < 100 ? 'text-yellow-600' : 'text-green-600';
        const label = `${end.toLocaleDateString()} - ${nextEnd.toLocaleDateString()}`;
        dates.push({ label, billTotal, balance: balance.toFixed(2), warning });

        const key = `${end.getFullYear()}-${end.getMonth() + 1}`;
        monthlySums[key] = (monthlySums[key] || 0) + parseFloat(balance.toFixed(2));
      }

      return { dates, monthlySums };
    }

    function generateProjections() {
      const container = document.getElementById('projectionsContainer');
      container.innerHTML = '';
      const { dates, monthlySums } = getNextCycle(currentStartDate, currentFrequency);

      let min = dates[0], max = dates[0];
      dates.forEach(cycle => {
        if (+cycle.balance < +min.balance) min = cycle;
        if (+cycle.balance > +max.balance) max = cycle;

        const el = document.createElement('div');
        el.className = `border p-2 rounded shadow ${cycle.warning}`;
        el.innerHTML = `<strong>${cycle.label}</strong><br/>Bills: $${cycle.billTotal.toFixed(2)} | Balance: $${cycle.balance}`;
        container.appendChild(el);
      });

      document.getElementById('summary').innerHTML = `
        Lowest Balance: ${min.label} ($${min.balance})<br>
        Highest Balance: ${max.label} ($${max.balance})
      `;

      updateChart(monthlySums);
    }

    function updateChart(monthlySums) {
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      const labels = Object.keys(monthlySums);
      const values = Object.values(monthlySums);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Projected Balance',
            data: values,
            fill: true,
            borderColor: 'blue',
            backgroundColor: 'rgba(59, 130, 246, 0.1)'
          }]
        }
      });
    }

    document.getElementById('toggleProjections').onclick = () => {
      const section = document.getElementById('projectionsContainer');
      const toggle = document.getElementById('toggleProjections');
      if (section.classList.toggle('hidden')) {
        toggle.textContent = 'Show';
      } else {
        toggle.textContent = 'Hide';
      }
    };

    document.getElementById('startDatePicker').addEventListener('change', e => {
      currentStartDate = new Date(e.target.value);
      generateProjections();
    });

    document.getElementById('financeCard').addEventListener('click', () => {
      document.getElementById('financeView').classList.add('hidden');
      document.getElementById('financeForm').classList.remove('hidden');
      document.getElementById('balanceInput').value = currentBalance;
      document.getElementById('frequencyInput').value = currentFrequency;
    });

    document.getElementById('financeForm').addEventListener('submit', async e => {
      e.preventDefault();
      const newBalance = parseFloat(document.getElementById('balanceInput').value);
      const newFreq = document.getElementById('frequencyInput').value;
      const newFood = parseFloat(document.getElementById('foodInput').value);
      const newFuel = parseFloat(document.getElementById('fuelInput').value);

      await supabase.from('balances').update({
        current_balance: newBalance,
        pay_frequency: newFreq,
        food_allowance: newFood,
        fuel_allowance: newFuel
      }).eq('user_id', userId);

      currentBalance = newBalance;
      currentFrequency = newFreq;
      document.getElementById('financeView').classList.remove('hidden');
      document.getElementById('financeForm').classList.add('hidden');
      loadData();
    });

    loadData();
  </script>
</body>
</html>