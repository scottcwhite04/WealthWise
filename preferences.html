<!DOCTYPE html>
<html lang="en" class="bg-gray-100 dark:bg-gray-900">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preferences – Wealthwise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
</head>
<body class="min-h-screen flex flex-col px-4 py-6">

  <div class="flex justify-between items-center mb-6">
    <button onclick="window.location.href='dashboard.html'" class="text-blue-600 hover:underline font-medium">
      ← Back to Dashboard
    </button>
    <h1 class="text-2xl font-bold dark:text-white">🏦 Banking Balance and Allowances</h1>
  </div>

  <form id="preferencesForm" class="space-y-4 bg-white dark:bg-gray-800 p-4 rounded shadow">
    <div>
      <label class="block text-sm font-medium dark:text-gray-200">Current Balance ($)</label>
      <input type="number" step="0.01" id="current_balance" class="mt-1 w-full rounded border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white" required>
    </div>

    <div>
      <label class="block text-sm font-medium dark:text-gray-200">Pay Frequency</label>
      <select id="pay_frequency" class="mt-1 w-full rounded border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white" required>
        <option value="weekly">Weekly</option>
        <option value="biweekly">Biweekly</option>
        <option value="monthly">Monthly</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium dark:text-gray-200">Food Allowance ($)</label>
      <input type="number" step="0.01" id="food_allowance" class="mt-1 w-full rounded border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white" required>
    </div>

    <div>
      <label class="block text-sm font-medium dark:text-gray-200">Fuel Allowance ($)</label>
      <input type="number" step="0.01" id="fuel_allowance" class="mt-1 w-full rounded border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white" required>
    </div>

    <div class="flex justify-between mt-6">
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">💾 Save</button>
      <button type="button" id="deleteBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">🗑️ Delete</button>
    </div>
  </form>

  <div id="toast" class="fixed bottom-4 right-4 hidden p-3 rounded shadow text-white text-sm"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(
      'https://anwwjqupywbnwanuckdf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFud3dqcXVweXdibndhbnVja2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MzgxOTksImV4cCI6MjA2NTAxNDE5OX0.ExlSkJTP3mJ9u-7SVws0FYcNvlL9a4MJNsm8ZaK1X48'
    )

    const form = document.getElementById('preferencesForm')
    const deleteBtn = document.getElementById('deleteBtn')
    const toast = document.getElementById('toast')

    const showToast = (message, type = 'success') => {
      toast.innerText = message
      toast.className = `fixed bottom-4 right-4 p-3 rounded shadow text-white text-sm ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
      }`
      toast.classList.remove('hidden')
      setTimeout(() => {
        toast.classList.add('hidden')
        if (type === 'success') window.location.href = 'dashboard.html'
      }, 2000)
    }

    const user = await supabase.auth.getUser()
    const userId = user?.data?.user?.id

    async function loadPreferences() {
      const { data, error } = await supabase
        .from('balances')
        .select('*')
        .eq('user_id', userId)
        .single()

      if (data) {
        document.getElementById('current_balance').value = data.current_balance
        document.getElementById('pay_frequency').value = data.pay_frequency
        document.getElementById('food_allowance').value = data.food_allowance
        document.getElementById('fuel_allowance').value = data.fuel_allowance
        deleteBtn.classList.remove('hidden')
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      const current_balance = parseFloat(document.getElementById('current_balance').value)
      const pay_frequency = document.getElementById('pay_frequency').value
      const food_allowance = parseFloat(document.getElementById('food_allowance').value)
      const fuel_allowance = parseFloat(document.getElementById('fuel_allowance').value)

      const { data, error } = await supabase
        .from('balances')
        .upsert({
          user_id: userId,
          current_balance,
          pay_frequency,
          food_allowance,
          fuel_allowance
        }, { onConflict: ['user_id'] })

      if (error) {
        showToast("Error saving preferences", "error")
      } else {
        showToast("Preferences saved!", "success")
        deleteBtn.classList.remove('hidden')
      }
    })

    deleteBtn.addEventListener('click', async () => {
      const { error } = await supabase
        .from('balances')
        .delete()
        .eq('user_id', userId)

      if (error) {
        showToast("Error deleting preferences", "error")
      } else {
        showToast("Preferences deleted", "success")
        form.reset()
        deleteBtn.classList.add('hidden')
      }
    })

    if (userId) loadPreferences()
  </script>
</body>
</html>